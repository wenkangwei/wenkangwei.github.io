<!doctype html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.lug.ustc.edu.cn/css?family=lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="PySpark,Data Analysis,KMean Clustering,Machine Learning," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/icon.png?v=5.1.0" />






<meta property="og:type" content="article">
<meta property="og:title" content="PySpark-Note-1">
<meta property="og:url" content="https://github.com/wenkangwei/wenkangwei.github.io%60/2020/10/12/PySpark-Note-1/index.html">
<meta property="og:site_name" content="Wenkang&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-10-12T21:37:41.000Z">
<meta property="article:modified_time" content="2020-10-12T21:58:10.786Z">
<meta property="article:author" content="Wenkang Wei">
<meta property="article:tag" content="PySpark">
<meta property="article:tag" content="Data Analysis">
<meta property="article:tag" content="KMean Clustering">
<meta property="article:tag" content="Machine Learning">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/wenkangwei/wenkangwei.github.io`/2020/10/12/PySpark-Note-1/"/>





  <title> PySpark-Note-1 | Wenkang's Blog </title>
<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wenkang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            Schedule
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://github.com/wenkangwei/wenkangwei.github.io`/2020/10/12/PySpark-Note-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wenkang Wei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wenkang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                PySpark-Note-1
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-12T17:37:41-04:00">
                2020-10-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PySpark/" itemprop="url" rel="index">
                    <span itemprop="name">PySpark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <img src=https://miro.medium.com/max/800/1*nPcdyVwgcuEZiEZiRqApug.jpeg>
<a id="more"></a>

<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This note is to introduce some useful functions in PySpark and also do some practice with them to analyze SF crime dataset. Then KMean Clustering model is applied to show how to use ML model in PySpark.</p>
<h2 id="List-of-Useful-Functions"><a href="#List-of-Useful-Functions" class="headerlink" title="List of Useful Functions"></a>List of Useful Functions</h2><ol>
<li><p>Create Spark Session</p>
<ul>
<li><p><strong>SparkSession</strong><br>  Create spark session, the main entry to create DataFrame, register DataFrame as tables, execute SQL over tables, cache tables, and read parquet files. </p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> SparkSession</span><br><span class="line">spark = SparkSession.builder \</span><br><span class="line">.master(<span class="string">"local"</span>) \</span><br><span class="line">.appName(<span class="string">"Word Count"</span>) \</span><br><span class="line">.config(<span class="string">"spark.some.config.option"</span>, <span class="string">"some-value"</span>) \</span><br><span class="line">.getOrCreate()</span><br></pre></td></tr></table></figure>
<p>  Explanation:</p>
<ul>
<li>.master(‘local’): sets the Spark master URL to connect to. “local” mean run spark locally. Just like a local server</li>
<li>.appName(“Word Count”) : application name</li>
<li>.config(“spark.some.config.option”, “some-value”): configure some key-value pair in application</li>
<li>.getOrCreate():  Gets an existing SparkSession or, if there is no existing one, creates a new one</li>
</ul>
</li>
<li><p><strong>SQLContext</strong><br> <strong>As of Spark 2.0, this is replaced by SparkSession</strong>. However, this class is kept here for backward compatibility.<br>  A SQLContext can be used create DataFrame, register DataFrame as tables, execute SQL over tables, cache tables,and read parquet files.</p>
</li>
</ul>
</li>
<li><p><strong>Load data</strong><br> After we create a SparkSession, we can use the following code to read data from CSV or JSON file.<br> <strong>Returned Object:</strong> PySpark DataFrame object</p>
<ul>
<li>csv<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set delimiter = ";" between columns</span></span><br><span class="line"><span class="comment"># Skip header of file if header=True. </span></span><br><span class="line"><span class="comment"># Otherwise, load header as data record</span></span><br><span class="line">spark.read.options(header= <span class="literal">True</span>,delimiter=<span class="string">";"</span>) \</span><br><span class="line">.csv(<span class="string">"path-to-dataset/dataset.csv"</span>)</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">spark.read.options(header= <span class="literal">True</span>,delimiter=<span class="string">";"</span>) \</span><br><span class="line">.format(<span class="string">'csv'</span>).load(<span class="string">"path-to-dataset/dataset.csv"</span>)</span><br></pre></td></tr></table></figure></li>
<li>json<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spark.read.json(<span class="string">"path-to-dataset/dataset.json"</span>)</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">spark.read.format(<span class="string">'json'</span>).load(<span class="string">"path-to-dataset/dataset.json"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>Useful functions of pyspark.sql.DataFrame with SQL</strong></p>
</li>
</ol>
<ul>
<li><p><strong>Create DataFrame and SQL table</strong></p>
<ul>
<li><p><strong>df.createDataFrame(data, schema=None)</strong>:<br>  create  PySpark dataframe<br>  <strong>data</strong>: a list of tuples,each tuple contains the data of a row<br>  <strong>schema</strong>: a list of column names of dataframe</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spark = SparkSession.builder\</span><br><span class="line">.master(<span class="string">"local"</span>).appName(<span class="string">"Word Count"</span>)\</span><br><span class="line">.config(<span class="string">"spark.some.config.option"</span>, <span class="string">"some-value"</span>).getOrCreate()</span><br><span class="line">l1 = [(<span class="string">'Alice'</span>, <span class="number">1</span>)]</span><br><span class="line">new_row1 = spark.createDataFrame(l1,[<span class="string">"name"</span>,<span class="string">"age"</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>df.createGlobalTempView(view_name)</strong><br>  Creates a <em>global</em> temporary <em>view</em> with this DataFrame.</p>
</li>
<li><p><strong>df.createOrReplaceTempView(view_name):</strong><br>  Creates or replaces a <em>local</em> temporary <em>view</em> with this DataFrame.</p>
</li>
<li><p><strong>df.registerDataFrameAsTable(table_name):</strong><br>  Registers the given DataFrame as a <em>temporary table</em> in the catalog.</p>
<br>
</li>
</ul>
</li>
<li><p><strong>Show Columns, Rows, Statistic description</strong></p>
<ul>
<li><p><strong>df.columns</strong>: a list of column names</p>
</li>
<li><p><strong>df.summary()</strong>: Computes specified <strong>statistics</strong> for numeric and string columns, with <em>count - mean - stddev - min - max</em>.</p>
</li>
<li><p><strong>df.describe()</strong>: Computes basic statistics for numeric and string columns. Similar to <em>summary()</em></p>
</li>
<li><p><strong>df.printSchema()</strong>: print Schema / decriptions of each column, like data type</p>
<br>
</li>
</ul>
</li>
<li><p><strong>Query and Selection</strong></p>
<ul>
<li><p><strong>df.head(10)</strong>: return the top 10 rows in Row type, <strong>not DataFrame</strong></p>
</li>
<li><p><strong>df.tail(10)</strong>:return the last 10 rows in Row type, <strong>not DataFrame</strong></p>
</li>
<li><p><strong>df.where(condition) or df.filter(condition)</strong> :  select the rows which satisfy the conditions. <strong>Return a DataFrame</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Select ages that are &lt; 100 and City name = "SF"</span></span><br><span class="line"><span class="comment"># Using SQL expression in conditions</span></span><br><span class="line">df.where(<span class="string">"age &lt; 100 and city in ('SF') "</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Using Spark API</span></span><br><span class="line"><span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> Row</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> col</span><br><span class="line">df.where(col(<span class="string">"age"</span>)&lt;<span class="number">100</span> &amp; col(<span class="string">'city'</span>).isin([<span class="string">"SF"</span>]))</span><br></pre></td></tr></table></figure></li>
<li><p><strong>df.column.isin([‘a’,’b’])</strong><br>Check if the value in a column is in the list or not</p>
</li>
<li><p><strong>df.column.between(lower_bound, upper_bound)</strong><br>check if the value is within a range or not</p>
</li>
<li><p><strong>df.select([“column-name”])</strong>:<br>select the columns based on a list of given column-names</p>
</li>
<li><p><strong>df.take(N)</strong>:<br>Return a list the top  N rows in Row() format</p>
</li>
<li><p><strong>df.collect()</strong>:<br>convert pyspark dataframe to a list of row in Row() format</p>
<br>
</li>
</ul>
</li>
<li><p><strong>Handle data</strong></p>
<ul>
<li><strong>df.withColumn(‘column_name’, col)</strong>:<br>append a column  to dataframe with name “column_name”</li>
</ul>
<p>  <strong>col</strong>: a Column expression for the new column. we can use UDF (user defined function) to it as well.</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df = df.withColumn(<span class="string">"age"</span>, df.age+<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>df.withColumnRenamed(“old name”,”new name”)</strong>:<br>rename a column in the dataframe</p>
</li>
<li><p><strong>df.drop([“column-name”]),  df.dropna(subset =[“column-name”]))</strong>:<br>drop columns and drop the rows with NaN in selected columns</p>
</li>
<li><p><strong>df.dropDuplicates([“column-name-to-remove-duplicated-value”])</strong>:<br>drop duplicated rows in selected coumns</p>
</li>
<li><p><strong>df.fillna(), df.fill_duplicates()</strong>: fill na with given values</p>
</li>
<li><p><strong>df.spark.sql.Row(age=10, name=’A’)</strong>:<br>Return a row with elements: age=10, name=’A’</p>
</li>
<li><p><strong>df.orderBy([“column-name”], ascending=False), df.sortBy()</strong>:<br>orderBy is an alias of sortBy, they sort the dataframe along given column names</p>
</li>
<li><p><strong>df.groupby().agg() / df.groupby().count()</strong><br>Apply aggregation function, such as count()  to a group</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># First select group based on column A, B.  Then count the amount of group "A"</span></span><br><span class="line"><span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> functions <span class="keyword">as</span> F</span><br><span class="line">df.groupby([<span class="string">"A"</span>]).agg(F.count(df.A))</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>Append New Rows</strong>        </p>
<ul>
<li><p><strong>df.union()</strong>:<br>Return a new DataFrame containing union of rows in this and another DataFrame, based on <strong>position</strong>.</p>
</li>
<li><p><strong>df.unionByName([“colunm-name”])</strong><br>The difference between this function and union() is that this function <strong>resolves columns by name</strong> (not by position)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new_row =  spark.createDataFrame([(<span class="string">"A"</span>,<span class="number">1</span>)],[<span class="string">"name"</span>,<span class="string">"count"</span>])</span><br><span class="line">df = df.union()</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>SQL</strong></p>
<ul>
<li>df = SparkSession.sql(“select * from table”)</li>
</ul>
</li>
<li><p><strong>Display Data</strong></p>
<ul>
<li>df.show(n)</li>
</ul>
</li>
<li><p><strong>Data Types Convertion with Pandas</strong>  </p>
<ul>
<li><p><strong>df.toPandas()</strong><br>convert dataframe to pandas dataframe</p>
</li>
<li><p><strong>df.toDF()</strong><br>convert a list of Rows to PySpark dataframe</p>
</li>
<li><p><strong>Convert Pandas DataFrame to PySpark DataFrame using Schema</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark.sql.types <span class="keyword">import</span> *</span><br><span class="line">mySchema = StructType([ StructField(<span class="string">"col name1"</span>, IntegerType(), <span class="literal">True</span>)\</span><br><span class="line">                    ,StructField(<span class="string">"col name2"</span>, StringType(), <span class="literal">True</span>)\</span><br><span class="line">                    ,StructField(<span class="string">"col name3"</span>, IntegerType(), <span class="literal">True</span>)])</span><br><span class="line">spark_df = spark.createDataFrame(df, mySchema)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ol start="4">
<li>Using Resilient distributed Dataset (RDD)<br> RDD represents an immutable, partitioned collection of elements that can be operated on in parallel.<br> Please refer to the  official website about RDD<br>

</li>
</ol>
<h2 id="Practice-with-Example-SF-Crime-data"><a href="#Practice-with-Example-SF-Crime-data" class="headerlink" title="Practice with Example: SF Crime data"></a>Practice with Example: SF Crime data</h2><ol start="0">
<li><p><strong>Requirements:</strong></p>
<ul>
<li>Find a platform for distributed computing, like databricks</li>
<li>Install PySpark</li>
</ul>
</li>
<li><p><strong>Download SF Crime Data for Demo</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.get(<span class="string">"https://data.sfgov.org/api/views/tmnf-yvry/rows.csv?accessType=DOWNLOAD"</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"sf_crime.csv"</span>,<span class="string">"w"</span>) <span class="keyword">as</span> f</span><br><span class="line">    f.write(r.content)</span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Load Data with PySpark</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> SparkSession</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> to_date, to_timestamp, hour</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> year, month, dayofmonth, date_format</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> from_unixtime, unix_timestamp</span><br><span class="line"></span><br><span class="line"><span class="comment"># create SparkSession entry to handle data</span></span><br><span class="line">spark = SparkSession \</span><br><span class="line">    .builder \</span><br><span class="line">    .appName(<span class="string">"crime analysis"</span>) \</span><br><span class="line">    .config(<span class="string">"spark.some.config.option"</span>, <span class="string">"some-value"</span>) \</span><br><span class="line">    .getOrCreate()</span><br><span class="line"><span class="comment"># load csv data</span></span><br><span class="line">df_opt1 = spark.read.option(<span class="string">"header"</span>, <span class="string">"true"</span>).csv(data_path)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p><strong>Visualize Data</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a view called "sf_crime" to the dataframe, so that we can use SQL</span></span><br><span class="line"><span class="comment"># to query data later</span></span><br><span class="line">df_opt1.createOrReplaceTempView(<span class="string">'sf_crime'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  if using databricks, we can use display function to see the data</span></span><br><span class="line">display(df_opt1 )</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">df_opt1.show()</span><br><span class="line"><span class="comment"># or </span></span><br><span class="line"><span class="comment"># show the schema of dataframe</span></span><br><span class="line">df_opt1.printSchema()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Clean Data</strong><br>Change the string data type to date type, integer type and other suitable data type</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># convert data type and replace data</span></span><br><span class="line">df_opt1 = df_opt1.withColumn(<span class="string">'Hour'</span>, hour(df_opt1[<span class="string">'Time'</span>]))</span><br><span class="line"><span class="comment"># convert string to date type using unix_timestamp</span></span><br><span class="line">df_opt1 = df_opt1.withColumn(<span class="string">"Date"</span>,  to_date( from_unixtime(unix_timestamp(df_opt1[<span class="string">'Date'</span>], <span class="string">'MM/dd/yyy'</span>))))</span><br><span class="line">df_opt1 = df_opt1.withColumn(<span class="string">"Year"</span>,  year(df_opt1.Date))</span><br><span class="line">df_opt1 = df_opt1.withColumn(<span class="string">"Month"</span>,  month(df_opt1.Date))</span><br><span class="line">df_opt1 = df_opt1.withColumn(<span class="string">"Day"</span>,  dayofmonth(df_opt1.Date))</span><br><span class="line">df_opt1 = df_opt1.withColumn(<span class="string">'HasCriminal'</span>, (df_opt1[<span class="string">"category"</span>]!=<span class="string">"NON-CRIMINAL"</span>))</span><br><span class="line">df_opt1 = df_opt1.withColumn(<span class="string">"X"</span>,  df_opt1[<span class="string">"X"</span>].cast(<span class="string">"double"</span>))</span><br><span class="line">df_opt1 = df_opt1.withColumn(<span class="string">"Y"</span>,  df_opt1[<span class="string">"Y"</span>].cast(<span class="string">"double"</span>))</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><strong>Query and Select data I’m interested in</strong><br>I want to analyze the count of crime of each category here, so there are two ways to do this.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Display Count of cime using SQL</span></span><br><span class="line">crimeCategory = spark.sql(<span class="string">"SELECT  category, COUNT(*) AS crime_counts FROM sf_crime GROUP BY category ORDER BY crime_counts DESC"</span>)</span><br><span class="line">crimes_pd_df = crimeCategory.toPandas()</span><br><span class="line">display(crimeCategory)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Display Count of crime of each category Using PySpark</span></span><br><span class="line">crime_category_df = df_opt1.groupby(<span class="string">'category'</span>).count().orderBy(<span class="string">'count'</span>,ascending=<span class="literal">False</span>)</span><br><span class="line">crime_category_df = crime_category_df.withColumnRenamed(<span class="string">'count'</span>, <span class="string">'crime_counts'</span>)</span><br><span class="line">crime_category_df = crime_category_df.toPandas()</span><br><span class="line">display(crime_category_df)</span><br></pre></td></tr></table></figure>

<p><strong>Result</strong></p>
<img src=/images/spark/count.png>

<h2 id="Advance-Topic-Machine-Learning-Model"><a href="#Advance-Topic-Machine-Learning-Model" class="headerlink" title="Advance Topic: Machine Learning Model"></a>Advance Topic: Machine Learning Model</h2><p>Using KMean Clustering to find the 5 centers in which crimes occur frequently</p>
<ol>
<li><strong>Select Position data X,Y and then Use Interquantile Range method to find outliers of position</strong><br>Since KMean Clustering is sensitive to the outlier as it uses mean method to find the center of clusters,  we need to remove outliers first. </li>
</ol>
<ul>
<li><strong>Quantile Based method to remove outlier</strong>:</li>
</ul>
<p><strong>The outlier is defined as the data point that drop outside the range [Q1-1.5<em>IQR ,  Q3+1.5</em>IQR]</strong>,<br>where Q1 and Q3 are  the first and third quantile of dataset and IQR = Q3-Q1 is the interquantile range.<br><br></p>
<ul>
<li><strong>API in PySpark to find quantile:</strong></li>
</ul>
<p><strong>df.approxQuantile(col, probabilities, relativeError)</strong>:<br><strong>col:</strong> column to find quantile<br><strong>probabilities:</strong> a list of quantile probabilities we want to find. Here I want to find Q1 =0.25 and  Q3=0.75<br><strong>return</strong>: the a list values that correspond to the quantile in probabilities list.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># select the positions where crimes occur</span></span><br><span class="line">crime_cluster_df = df_opt1.where(<span class="string">"hasCriminal =true"</span>).select([<span class="string">"Hour"</span>, <span class="string">"PdDistrict"</span>, <span class="string">"X"</span>,<span class="string">"Y"</span>, <span class="string">"DayOfWeek"</span>, <span class="string">"category"</span>,<span class="string">"Resolution"</span>,<span class="string">"hasCriminal"</span>])</span><br><span class="line"><span class="comment"># crime_cluster_df.show()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Find the Q1, Q 3 Quantile</span></span><br><span class="line">bounds = &#123;</span><br><span class="line">    c: dict(</span><br><span class="line">        zip([<span class="string">"q1"</span>, <span class="string">"q3"</span>], crime_cluster_df.approxQuantile(c, [<span class="number">0.25</span>, <span class="number">0.75</span>], <span class="number">0</span>))</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> crime_cluster_df.select([<span class="string">"X"</span>,<span class="string">"Y"</span>]).columns</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># compute lower bound and upper bound of normal data</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> bounds:</span><br><span class="line">    iqr = bounds[c][<span class="string">'q3'</span>] - bounds[c][<span class="string">'q1'</span>]</span><br><span class="line">    bounds[c][<span class="string">'lower'</span>] = bounds[c][<span class="string">'q1'</span>] - (iqr * <span class="number">1.5</span>)</span><br><span class="line">    bounds[c][<span class="string">'upper'</span>] = bounds[c][<span class="string">'q3'</span>] + (iqr * <span class="number">1.5</span>)</span><br></pre></td></tr></table></figure>
<br>

<ol start="2">
<li><p>Remove Outliers based on upper bound and lower bound of quantile</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> *</span><br><span class="line">crime_cluster_df = crime_cluster_df.select([<span class="string">"X"</span>,<span class="string">"Y"</span>])\</span><br><span class="line">.where(col(<span class="string">"X"</span>).between(bounds[<span class="string">'X'</span>][<span class="string">'lower'</span>], bounds[<span class="string">'X'</span>][<span class="string">'upper'</span>])) \</span><br><span class="line">.where(col(<span class="string">"Y"</span>).between(bounds[<span class="string">'Y'</span>][<span class="string">'lower'</span>], bounds[<span class="string">'Y'</span>][<span class="string">'upper'</span>]))</span><br></pre></td></tr></table></figure>
<br>
</li>
<li><p>Assemble columns into one feature column before training<br>In PySpark, we need to put all feature columns into one single feature column  before we train the model.</p>
</li>
</ol>
<p><strong>VectorAssembler</strong> provides a way to assemble those features into one column.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ensemble multiple columns into one single feature column for training KMean Clustering</span></span><br><span class="line"><span class="keyword">from</span> pyspark.ml.feature <span class="keyword">import</span> VectorAssembler</span><br><span class="line">vecAssembler = VectorAssembler(inputCols=[<span class="string">"X"</span>, <span class="string">"Y"</span>], outputCol=<span class="string">"features"</span>)</span><br><span class="line">crime_cluster_df = vecAssembler.transform(crime_cluster_df.select([<span class="string">"X"</span>,<span class="string">"Y"</span>]))</span><br></pre></td></tr></table></figure>
<br>

<ol start="4">
<li>KMean Clustering to learn data<br>In Machine Learning of PySpark, we need to set the name of feature column to <strong>“features”</strong>, otherwise, set <code>featuresCol=&quot;column-name&quot;</code> to select which feature column to learn in dataframe</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Training KMean clustering</span></span><br><span class="line"><span class="keyword">from</span> pyspark.ml.clustering <span class="keyword">import</span> BisectingKMeans</span><br><span class="line">K=<span class="number">5</span></span><br><span class="line">bkm = BisectingKMeans(k=K, minDivisibleClusterSize=<span class="number">1.0</span>)</span><br><span class="line">model = bkm.fit(crime_cluster_df)</span><br><span class="line"><span class="comment"># predict at one single point</span></span><br><span class="line"><span class="comment"># print(model.predict(crime_cluster_df.head().features))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># predict clusters</span></span><br><span class="line"><span class="comment"># Output the prediction to the column called "Prediction"</span></span><br><span class="line">model.setPredictionCol(<span class="string">"Prediction"</span>)</span><br><span class="line">transformed = model.transform(crime_cluster_df).select(<span class="string">"X"</span>,<span class="string">"Y"</span>, <span class="string">"Prediction"</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Result</strong></p>
<img src=/images/spark/cluster.png>

<br>

<img src=/images/spark/centers.png>

<br>

<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This tutorial introduce:</p>
<ol>
<li>List of useful PySpark functions and their basic usage</li>
<li>Use SF Crime dataset as a demo to see how to use PySpark to manipulate data and visualize them</li>
<li>How to use machine learning model: KMean Clustering in PySpark to learn data. <strong>Note: the APIs of ML in PySpark are  different from sklearn. Need to Pay attention to the difference.</strong><br>

</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://spark.apache.org/docs/latest/api/python/pyspark.sql.html?highlight=read#pyspark.sql.DataFrameReader" target="_blank" rel="noopener">SparkReader,Writer</a><br>[2] <a href="https://spark.apache.org/docs/latest/api/python/pyspark.sql.html#pyspark.sql.DataFrame.filter" target="_blank" rel="noopener">PySpark,SQL_module</a><br>[3] <a href="https://spark.apache.org/docs/2.2.0/api/python/_modules/pyspark/ml/classification.html" target="_blank" rel="noopener">PySpark,ML_module</a><br>[4] <a href="https://stackoverflow.com/questions/52633916/outlier-detection-in-pyspark" target="_blank" rel="noopener">PySpark,outlier_detection</a><br>[5] <a href="https://miro.medium.com/max/800/1*nPcdyVwgcuEZiEZiRqApug.jpeg" target="_blank" rel="noopener">logo</a></p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/wechat-qr-code.jpg" alt="Wenkang Wei wechat" style="width: 200px; max-width: 100%;"/>
    <div>subscribe to my blog by scanning my public wechat account</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PySpark/" rel="tag"># PySpark</a>
          
            <a href="/tags/Data-Analysis/" rel="tag"># Data Analysis</a>
          
            <a href="/tags/KMean-Clustering/" rel="tag"># KMean Clustering</a>
          
            <a href="/tags/Machine-Learning/" rel="tag"># Machine Learning</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/30/ML-Model-LR/" rel="next" title="ML Model - Regression models">
                <i class="fa fa-chevron-left"></i> ML Model - Regression models
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/11/02/DL-ConvolutionNetwork/" rel="prev" title="DeepLearning-1 ConvolutionNetwork">
                DeepLearning-1 ConvolutionNetwork <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Wenkang Wei" />
          <p class="site-author-name" itemprop="name">Wenkang Wei</p>
           
              <p class="site-description motion-element" itemprop="description">second-year master student / Computer engineering / deep learning / machine learning / data science </p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">57</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wenkangwei" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/wenkang-wei-588811167" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-fab fa-linkedin"></i>
                  
                  LinkedIn
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/wenkang.wei" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-fab fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#List-of-Useful-Functions"><span class="nav-number">2.</span> <span class="nav-text">List of Useful Functions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Practice-with-Example-SF-Crime-data"><span class="nav-number">3.</span> <span class="nav-text">Practice with Example: SF Crime data</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advance-Topic-Machine-Learning-Model"><span class="nav-number">4.</span> <span class="nav-text">Advance Topic: Machine Learning Model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">5.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wenkang Wei</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="[object Object]"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  




  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unjkp.com/valine/dist/Valine.min.js"></script>  
  <script src="/js/src/Valine.min.js"></script> 

   
  
  <script src="/js/src/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'kvXCKmDNxnA2486N29e5cP7i-MdYXbMMI',
        appKey: '0Lv5b0SqotzkGHQvD64u4AKo',
        placeholder: '说点什么吧！',
        avatar:'hide',
        guest_info:['nick'] , 
        pageSize:'10' || 10,
    });
   
    var infoEle = document.querySelector('#comments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0){
      infoEle.childNodes.forEach(function(item) {
        item.parentNode.removeChild(item);
      });
    }
  </script>

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  


  

</body>
</html>
